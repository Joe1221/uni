\@ifpackageloaded{xparse}{}{\RequirePackage [ log-declarations = false ] { xparse }}
\RequirePackage { expl3, l3keys2e }
\ProvidesExplPackage{mymath}{2013/11/16}{0.1}{Package intended to provide math utilities}

\RequirePackage { amsmath, amssymb }
\usepackage{relsize}
\usepackage{mathtools}

% Math symbols, operators, functions and relations
% ================================================

% Zahlenmengen
\newcommand{\K}{\mathbb{K}} % Körper
\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\N}{\mathbb{N}}
\DeclareDocumentCommand { \C } { } { \mathbb { C } }
\newcommand{\F}{\mathbb{F}}
\newcommand{\Q}{\mathbb{Q}}
\renewcommand{\P}{\mathbb{P}}

\DeclareDocumentCommand { \Quot } { } { \operatorname { Quot } }

\DeclareDocumentCommand { \div } { } { \operatorname { div } }
\DeclareDocumentCommand { \grad } { } { \operatorname { grad } }
\DeclareDocumentCommand { \rot } { } { \operatorname { rot } }

% fixme: add complete set of trig-functions
\DeclareDocumentCommand { \arcosh } { } { \operatorname { arcosh } }
% Font für Zeichen mit Doppelstrich
\usepackage{bbm}

\newcommand{\Id}{\operatorname{Id}} 		% Identity function
\newcommand{\Ind}{\operatorname{\mathbbm{1}}} 		% Indicator function
\newcommand{\sgn}{\operatorname{sgn}}       % Signum function
\DeclareDocumentCommand { \sign } { } { \operatorname { sgn } }
\DeclareDocumentCommand { \li } { } { \operatorname { li } }

\newcommand{\im}{\operatorname{im}}         % Image (in correspondence to \ker for kernel)
\newcommand{\supp}{\operatorname{supp}}     % Support of a function

\newcommand{\tr}{\operatorname{tr}}         % Trace of a matrix

\newcommand{\argmax}{\operatornamewithlimits{arg\,max}}
\newcommand{\argmin}{\operatornamewithlimits{arg\,min}}
% todo: fix limits
\DeclareDocumentCommand { \esssup } { } { \operatornamewithlimits{ess\,sup} }

\DeclareDocumentCommand { \ceil } { m } { \left\lceil #1 \right\rceil }
\DeclareDocumentCommand { \floor } { m } { \left\lfloor #1 \right\rfloor }

\renewcommand{\Re}{\operatorname{Re}}       % Real part
\renewcommand{\Im}{\operatorname{Im}}       % Imaginary part

\newcommand{\orth}{\perp}                   % Orthogonal sign
\providecommand{\bigtimes}{\mathop{\mathlarger{\times}}}

\DeclareDocumentCommand { \divs } { s } {
    \mathchoice {
	\IfBooleanTF { #1 } { \mathop{\big\|} } { \mathop{\big|} }
    } {
	\IfBooleanTF { #1 } { \mathop{\big\|} } { \mathop{\big|} }
    } {
	\IfBooleanTF { #1 } { \mkern-1mu \mathop{\|} \mkern-1mu } { \mkern-1mu \mathop{|} \mkern-1mu }
    } {
	\IfBooleanTF { #1 } { \mkern-1mu \mathop{\|} \mkern-1mu } { \mkern-1mu \mathop{|} \mkern-1mu }
    }
}
\DeclareDocumentCommand { \ndivs } { s } {
    \mathchoice {
	\IfBooleanTF { #1 } { \mathop{\not\big\|} } { \mathop{\not\big|} }
    } {
	\IfBooleanTF { #1 } { \mathop{\not\big\|} } { \mathop{\not\big|} }
    } {
	\IfBooleanTF { #1 } { \mkern-1mu \mathop{\not\|} \mkern-1mu } { \mkern-1mu \mathop{\not|} \mkern-1mu }
    } {
	\IfBooleanTF { #1 } { \mkern-1mu \mathop{\not\|} \mkern-1mu } { \mkern-1mu \mathop{\not|} \mkern-1mu }
    }
}

% Uncommon/Deprecated commands (to be removed/reviewed)
\newcommand{\isomorph}{\cong}               % Isomorphic
\newcommand{\Mat}{\operatorname{Mat}}       % Matrix space (rather use K^{n\times m})
\newcommand{\diag}{\operatorname{diag}}     % Diagonal matrix
\newcommand{\Eig}{\operatorname{Eig}}       % Eigenspace
\newcommand{\Res}{\operatorname{Res}}
\newcommand{\Var}{\operatorname{Var}}
%\renewcommand{\div}{\operatorname{div}}
\newcommand{\adj}{\operatorname{adj}}
\newcommand{\ad}{\operatorname{ad}}
\newcommand{\End}{\operatorname{End}}
\newcommand{\Abb}{\operatorname{Abb}}
\newcommand{\Hom}{\operatorname{Hom}}
\newcommand{\rg}{\operatorname{rg}}
\newcommand{\GL}{\operatorname{GL}}
\newcommand{\cond}{\operatorname{cond}}
\newcommand{\card}{\operatorname{card}}
\newcommand{\SO}{\operatorname{SO}}
\newcommand{\Index}{\operatorname{Index}}
\newcommand{\ggT}{\operatorname{ggT}}
\newcommand{\kgV}{\operatorname{kgV}}
\DeclareDocumentCommand { \Aut } { } { \operatorname { Aut } }
\DeclareDocumentCommand { \injto } { } { \hookrightarrow }

\DeclareDocumentCommand { \isomorphic } { } { \mathrel { \cong } }
\DeclareDocumentCommand { \LandauO } { } { O }
\DeclareDocumentCommand { \Landauo } { } { o }
\DeclareDocumentCommand { \LandauTheta } { } { \Theta }
\DeclareDocumentCommand { \Laplace } { } { \mathop { \Delta } \nolimits }
% use \mathop to vertically center \nabla
\DeclareDocumentCommand { \Nabla } { } { \mathord{ \mathop { \nabla } } }
\DeclareDocumentCommand { \diam } { } { \operatorname { diam } \nolimits }
\DeclareDocumentCommand { \boundary } { } { \partial }
\DeclareDocumentCommand { \Boundary } { } { \partial }
\DeclareDocumentCommand { \IdealOf } { } { \mathbin{\trianglelefteq} }
\DeclareDocumentCommand { \NormalSubgroup } { } { \mathbin{\trianglelefteq} }

\ExplSyntaxOff
\RequirePackage { tikz }
\usetikzlibrary { arrows, positioning }
\RequirePackage { tikz-cd }
\tikzset {
    commutative diagrams/sur/.style = { two heads },
    commutative diagrams/inj/.style = { hook },
    commutative diagrams/bij/.style = { inj, sur },
    commutative diagrams/hom/.style = { bij },
}
\ExplSyntaxOn


% Shortcuts, convenience mappings and various other things
% ========================================================

\keys_define:nn { envmath } {
    numbered-bool .bool_set:N = \l_envmath_numbered,
    numbered-single .bool_set:N = \l_envmath_numbered_single,
    numbered-multiple .bool_set:N = \l_envmath_numbered_multiple,
    numbered .choice:,
    numbered .default:n = single,
    numbered / single .meta:n = { numbered-bool, numbered-single },
    numbered / multiple .meta:n = { numbered-bool, numbered-multiple },
}

\DeclareDocumentEnvironment { math } { o } {
    \IfNoValueF { #1 } {
	\keys_set:nn { envmath } { #1 }
    }
    \bool_if:NTF \l_envmath_numbered {
	\bool_if:NTF \l_envmath_numbered_multiple {
	    \subequations
	    \align
	} {
	    \begin{equation}
	    \begin{aligned}
	}
    } {
	\begin{equation*}
	\begin{aligned}
    }
} {
    \bool_if:NTF \l_envmath_numbered {
	\bool_if:NTF \l_envmath_numbered_multiple {
	    \endalign
	    \endsubequations
	} {
	    \end{aligned}
	    \end{equation}
	    \par
	}
    } {
	\end{aligned}
	\end{equation*}
	\par
    }
}

\newcommand{\texp}[1]{\text{\footnotesize [#1]}}
\newcommand{\const}{\text{const}}

\renewcommand{\d}{\partial}                             % probably no good idea
\DeclareDocumentCommand { \di } { o } {
    \mathop { \mathrm{d}  #1}
}
\DeclareDocumentCommand { \dx } { O{x} }{
    \mathord { \mathrm{d} \mkern-1mu #1}
}

\DeclareDocumentCommand{\ddx}{ >{\SplitArgument{1}{^}}O{x} g }
{
	\IfValueTF{#2}{
		\ddx_int {\mathrm{d}}#1{#2}
	}{
		\ddx_int {\mathrm{d}}#1
	}
}
\DeclareDocumentCommand{\pddx}{ >{\SplitArgument{1}{^}}O{x} g }
{
	\IfValueTF{#2}{
		\ddx_int {\partial}#1{#2}
	}{
		\ddx_int {\partial}#1
	}
}
\DeclareDocumentCommand{\ddx_int}{ mmmG{} }
{
	\IfValueTF{#3}{
		\frac{
			{#1}^{#3} #4
		}{
			{#1}{#2}^{#3}
		}
	}{
		\frac{
			{#1} #4
		}{
			{#1} #2
		}
	}
}

% working with "&" directly causes category code trouble
\tl_set:Nx \c_mymath_set_delim_tl { }

\cs_new:Nn \mymath_set_vertbar:nn {
    \tl_clear_new:N \l_conten_tl
    \tl_set:Nf \l_conten_tl { #1 }
    \tl_replace_once:Nnn \l_conten_tl { \c_mymath_set_delim_tl } { \mathrel{}#2\mathrel{} }
    \l_conten_tl
}

\DeclareDocumentCommand { \Set } { om } {
    \tl_clear_new:N \l_content_tl
    \tl_set:Nn \l_content_tl { #2 }

    \tl_replace_all:Nnn \l_content_tl { & } { \c_mymath_set_delim_tl }

    \tl_if_in:NnTF \l_content_tl { \c_mymath_set_delim_tl } {
	\mathchoice {
	    \left\{ \big. \mkern1mu \mymath_set_vertbar:nn{\l_content_tl}{\middle|} \mkern2mu \right\}
	} {
	    \{ \mkern1mu \mymath_set_vertbar:nn{\l_content_tl}{\mkern-2mu | \mkern-2mu} \mkern1mu \}
	} {
	    \{ \mymath_set_vertbar:nn{\l_content_tl}{\mkern-1mu | \mkern-1mu} \}
	} {
	    \{ \mymath_set_vertbar:nn{\l_content_tl}{\mkern-1mu | \mkern-1mu} \}
	}
    } {
        \mathchoice {
            \left\{ \big.\mkern-1mu \l_content_tl \right\}
        } {
            \{ \l_content_tl \}
        } {
            \{ \l_content_tl \}
        } {
            \{ \l_content_tl \}
        }
    }
}

\DeclareDocumentCommand { \Span } { om } {
    \tl_clear_new:N \l_content_tl
    \tl_set:Nn \l_content_tl { #2 }

    \IfNoValueTF { #1 } {
	\left\langle \l_content_tl \right\rangle
    } {
	#1\langle \l_content_tl #1\rangle
    }
}

\DeclareDocumentCommand { \Vector } { slm } {
    \tl_clear_new:N \l_args_tl
    \tl_set:Nn \l_args_tl { #3 }
    \tl_replace_all:Nnn \l_args_tl { & } { \\ }
    \tl_replace_all:Nnn \l_args_tl { \dots } { \vdots }
    \IfBooleanTF { #1 } {
        \Matrix * #2 { \l_args_tl }
    } {
        \Matrix #2 { \l_args_tl }
    }
}

\DeclareDocumentCommand { \Matrix } { slm } {
    \IfBooleanTF { #1 } {
        \str_case:nnF { #2 } {
            { [  } { \begin{bmatrix} #3 \end{bmatrix} }
            { \{ } { \begin{Bmatrix} #3 \end{Bmatrix} }
            { |  } { \begin{vmatrix} #3 \end{vmatrix} }
            { \| } { \begin{Vmatrix} #3 \end{Vmatrix} }
        } { \begin{pmatrix} #3 \end{pmatrix} }
    } {
	\tl_clear_new:N \l_content_tl
	% Use \tl_set:Nf instead of \tl_set:Nn to expand a possible tokenlist variable in #3
	\tl_set:Nf \l_content_tl { #3 }
	\tl_replace_all:Nnn \l_content_tl { \vdots } { \svdots }
	\tl_replace_all:Nnn \l_content_tl { \ddots } { \sddots }
	\tl_replace_all:Nnn \l_content_tl { \cdots } { \scdots }
        \str_case:nnF { #2 } {
            { [  } { \left[  \big. \begin{smallmatrix} \l_content_tl \end{smallmatrix} \right]  }
            { \{ } { \left\{ \big. \begin{smallmatrix} \l_content_tl \end{smallmatrix} \right\} }
            { |  } { \left|  \big. \begin{smallmatrix} \l_content_tl \end{smallmatrix} \right|  }
            { \| } { \left\| \big. \begin{smallmatrix} \l_content_tl \end{smallmatrix} \right\| }
        } { \left( \big. \begin{smallmatrix} \l_content_tl \end{smallmatrix} \right) }
    }
}

\DeclareDocumentCommand { \ProofImplication } { s t( t) o o } {
    \normalfont \selectfont
    \IfNoValueTF { #4 } {
        „ \, $
        \IfBooleanTF { #1 } { \impliedby } { \implies }
        $ \, “
    } {
        „ \,
        \IfBooleanTF { #2 } { ( } { }
        \int_to_roman:n { #4 }
        \IfBooleanTF { #3 } { ) } { }
        $ \IfBooleanTF { #1 } { \impliedby } { \implies } $
        \IfBooleanTF { #2 } { ( } { }
        \int_to_roman:n { #5 }
        \IfBooleanTF { #3 } { ) } { }
        \, “
    }
}

\DeclareDocumentCommand { \sddots } { } {
    \scalebox { 0.5 } { \ensuremath { \ddots } }
}
\DeclareDocumentCommand { \svdots } { } {
    \scalebox { 0.5 } { \ensuremath { \vdots } }
}
\DeclareDocumentCommand { \scdots } { } {
    \raisebox { 0.20ex } { \scalebox { 0.5 } { \ensuremath { \cdots } } }
}




\renewcommand{\_}[1]{\overline{#1}}
\newcommand{\argdot}{{\,\cdot\,}}

\newcommand{\f}[2]{\frac{#1}{#2}}
\newcommand{\tf}[2]{\tfrac{#1}{#2}}

\newcommand{\<}{\langle}
\renewcommand{\>}{\rangle}

\renewcommand{\l}{\left}
\renewcommand{\r}{\right}

\newcommand{\scr}[1]{\mathcal{#1}}
\newcommand{\fixme}[1][]{\;\texttt{FIXME:} #1\;}
% Create an \item, but prevent spacing occuring when an align-environment follows
\newcommand{\itemdm}{\item\abovedisplayskip=0pt\abovedisplayshortskip=0pt~\vspace*{-\baselineskip}}


%\newcommand{\stack}[2][test]{\stackrel[#1]{\mathclap{#2}}{test}}
\newcommand{\stack}[3][]{\overset{\mathclap{#2}}{\underset{\mathclap{#1}}{#3}}}

% Algorithmen
%\newcommand{\Input}{\Require}
\newcommand{\Assume}{\Require}
\newcommand{\Assert}{\Require}
%\newcommand{\Output}{\Ensure}

\newcommand{\suchthat}{\;\ifnum\currentgrouptype=16 \middle\fi|\;}

\newcommand{\eps}{\epsilon}


% Localized mappings (probably german)
% ====================================

\newcommand{\jota}{\iota}
\newcommand{\my}{\mu}
\newcommand{\ny}{\nu}
\RequirePackage { xspace }
\DeclareDocumentCommand { \oBdA } { } { o.B.d.A.\xspace }
\DeclareDocumentCommand { \OBdA } { } { O.B.d.A.\xspace }

\DeclareDocumentEnvironment { psmallmatrix } { } {
    \left( \begin { smallmatrix }
} {
    \end{smallmatrix} \right)
}

% Purely cosmetic fixes for existing commands
% ===========================================

\let\oldforall\forall   \renewcommand{\forall}{\;\oldforall}
\let\oldexists\exists   \renewcommand{\exists}{\;\oldexists}
\let\oldland\land   \renewcommand{\land}{\,\oldland\,}
\let\oldlor\lor   \renewcommand{\lor}{\,\oldlor\,}

%\let\oldint\int   \renewcommand{\int}{\oldint\!} % non-functional

\DeclareDocumentCommand { \subset } { } { \subseteq }
\DeclareDocumentCommand { \supset } { } { \supseteq }

% TODO: generates error due to math font changes of fontspec?
%\renewcommand{\tilde}{\widetilde}
%\renewcommand{\hat}{\widehat}

\renewcommand{\phi}{\varphi}
\renewcommand{\epsilon}{\varepsilon}

\cs_set_eq:NN \oldtheta \theta
\DeclareDocumentCommand { \theta } { } { \vartheta }
\DeclareDocumentCommand { \vartheta } { } { \oldtheta }

\renewcommand{\vec}[1]{\overrightarrow{#1}}

% Smaller default fraction
\usepackage[11pt]{moresize}
\let\oldfrac\frac
\renewcommand{\frac}[2]{
	\mathchoice
	%{\genfrac{}{}{}{1}{\mathlarger{#1}}{\mathlarger{#2}}}
	{\tfrac{#1}{#2}}
	{\oldfrac{#1}{#2}}
	{\oldfrac{#1}{#2}}
	{\oldfrac{#1}{#2}}
}

\cs_set_eq:NN \oldbinom \binom
\DeclareDocumentCommand { \binom } { mm } {
    \mathchoice
	{ \tbinom { #1 } { #2 } }
	{ \oldbinom { #1 } { #2 } }
	{ \oldbinom { #1 } { #2 } }
	{ \oldbinom { #1 } { #2 } }
}

